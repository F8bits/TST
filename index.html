<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Roadmap completo de matem√°tica com progresso salvo no navegador para estudar do b√°sico ao avan√ßado em qualquer dispositivo." />
  <meta name="theme-color" content="#0f0f13" />
  <title>Math Roadmap</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #0f0f13;
      color: #e2e8f0;
      font-family: 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
    }

    header { text-align: center; padding: 40px 20px 20px; }
    header h1 {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(135deg, #a78bfa, #60a5fa, #34d399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      color: transparent;
    }
    header p { color: #94a3b8; margin-top: 8px; font-size: .95rem; }

    .progress-bar-wrap {
      max-width: 500px;
      margin: 16px auto;
      background: #1e1e2e;
      border-radius: 99px;
      height: 8px;
      overflow: hidden;
    }
    .progress-bar {
      height: 8px;
      border-radius: 99px;
      background: linear-gradient(90deg, #a78bfa, #60a5fa);
      width: 0%;
      transition: width .4s;
    }
    .progress-label {
      text-align: center;
      color: #64748b;
      font-size: .8rem;
      margin-top: 6px;
    }

    .top-actions {
      margin: 18px auto 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      border: 1px solid #2d2d44;
      background: #171726;
      color: #cbd5e1;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: .82rem;
      transition: .2s;
    }

    .btn:hover,
    .btn:focus-visible {
      border-color: #60a5fa;
      color: #f1f5f9;
      outline: none;
    }

    .feedback {
      color: #34d399;
      min-height: 1.2em;
      font-size: .76rem;
      text-align: center;
      margin-top: 6px;
    }

    .search-wrap {
      margin: 12px auto 0;
      max-width: 560px;
      padding: 0 10px;
    }

    .search-input {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #2d2d44;
      background: #171726;
      color: #e2e8f0;
      padding: 10px 12px;
      font-size: .86rem;
    }

    .search-input:focus-visible {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px #60a5fa22;
    }

    .roadmap {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px 16px 80px;
      position: relative;
    }

    .roadmap::before {
      content: '';
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom, #a78bfa22, #60a5fa44, #34d39922);
      transform: translateX(-50%);
    }

    .level { margin-bottom: 10px; }
    .level-header { text-align: center; margin: 32px 0 12px; position: relative; z-index: 2; }
    .level-badge {
      display: inline-block;
      padding: 4px 18px;
      border-radius: 99px;
      font-size: .75rem;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .nodes-row {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
      position: relative;
      z-index: 2;
      margin-bottom: 6px;
    }

    .node {
      background: #1a1a27;
      border: 1.5px solid #2d2d44;
      border-radius: 12px;
      padding: 14px 16px;
      width: 190px;
      cursor: pointer;
      transition: transform .2s, box-shadow .2s, border-color .2s;
      position: relative;
      user-select: none;
      text-align: left;
    }
    .node:hover,
    .node:focus-visible {
      transform: translateY(-3px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, .5);
      outline: none;
    }
    .node.done { opacity: .7; }
    .node.done::after {
      content: '‚úì';
      position: absolute;
      top: 8px;
      right: 10px;
      font-size: .8rem;
      color: #34d399;
      font-weight: 700;
    }

    .node-icon { font-size: 1.4rem; margin-bottom: 6px; }
    .node-title { font-size: .88rem; font-weight: 700; color: #f1f5f9; margin-bottom: 3px; }
    .node-sub { font-size: .72rem; color: #64748b; line-height: 1.4; }

    .lv0 .node { border-color: #7c3aed44; } .lv0 .node:hover, .lv0 .node:focus-visible { border-color: #7c3aed; box-shadow: 0 0 20px #7c3aed33; }
    .lv1 .node { border-color: #2563eb44; } .lv1 .node:hover, .lv1 .node:focus-visible { border-color: #2563eb; box-shadow: 0 0 20px #2563eb33; }
    .lv2 .node { border-color: #0891b244; } .lv2 .node:hover, .lv2 .node:focus-visible { border-color: #0891b2; box-shadow: 0 0 20px #0891b233; }
    .lv3 .node { border-color: #05966944; } .lv3 .node:hover, .lv3 .node:focus-visible { border-color: #059669; box-shadow: 0 0 20px #05966933; }
    .lv4 .node { border-color: #d9770644; } .lv4 .node:hover, .lv4 .node:focus-visible { border-color: #d97706; box-shadow: 0 0 20px #d9770633; }
    .lv5 .node { border-color: #dc262644; } .lv5 .node:hover, .lv5 .node:focus-visible { border-color: #dc2626; box-shadow: 0 0 20px #dc262633; }
    .lv6 .node { border-color: #db277744; } .lv6 .node:hover, .lv6 .node:focus-visible { border-color: #db2777; box-shadow: 0 0 20px #db277733; }
    .lv7 .node { border-color: #65a30d44; } .lv7 .node:hover, .lv7 .node:focus-visible { border-color: #65a30d; box-shadow: 0 0 20px #65a30d33; }
    .lv8 .node { border-color: #9333ea44; } .lv8 .node:hover, .lv8 .node:focus-visible { border-color: #9333ea; box-shadow: 0 0 20px #9333ea33; }

    .badge-lv0 { background: #7c3aed22; color: #a78bfa; border: 1px solid #7c3aed44; }
    .badge-lv1 { background: #2563eb22; color: #60a5fa; border: 1px solid #2563eb44; }
    .badge-lv2 { background: #0891b222; color: #38bdf8; border: 1px solid #0891b244; }
    .badge-lv3 { background: #05966922; color: #34d399; border: 1px solid #05966944; }
    .badge-lv4 { background: #d9770622; color: #fbbf24; border: 1px solid #d9770644; }
    .badge-lv5 { background: #dc262622; color: #f87171; border: 1px solid #dc262644; }
    .badge-lv6 { background: #db277722; color: #f472b6; border: 1px solid #db277744; }
    .badge-lv7 { background: #65a30d22; color: #a3e635; border: 1px solid #65a30d44; }
    .badge-lv8 { background: #9333ea22; color: #c084fc; border: 1px solid #9333ea44; }

    .connector {
      text-align: center;
      color: #334155;
      font-size: 1.2rem;
      margin: 4px 0;
      position: relative;
      z-index: 2;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: #000a;
      z-index: 100;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: #16162a;
      border: 1px solid #2d2d44;
      border-radius: 16px;
      max-width: 480px;
      width: 100%;
      padding: 28px;
      position: relative;
      animation: pop .2s ease;
    }
    @keyframes pop { from { transform: scale(.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal h2 { font-size: 1.2rem; font-weight: 800; margin-bottom: 4px; }
    .modal .modal-tags { display: flex; gap: 6px; flex-wrap: wrap; margin: 10px 0; }
    .modal .tag { font-size: .7rem; padding: 2px 10px; border-radius: 99px; background: #1e1e3a; color: #94a3b8; }
    .modal p { font-size: .85rem; color: #94a3b8; line-height: 1.6; margin-bottom: 12px; }
    .modal ul { font-size: .82rem; color: #94a3b8; padding-left: 18px; line-height: 1.8; }
    .modal .close-btn {
      position: absolute;
      top: 14px;
      right: 16px;
      background: none;
      border: none;
      color: #64748b;
      font-size: 1.3rem;
      cursor: pointer;
    }
    .modal .mark-btn {
      margin-top: 18px;
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-weight: 700;
      font-size: .9rem;
      cursor: pointer;
      background: #a78bfa;
      color: #0f0f13;
      transition: background .2s;
    }
    .modal .mark-btn:hover { background: #c4b5fd; }
    .modal .mark-btn.undone { background: #1e1e3a; color: #94a3b8; }

    :root {
      --bg: #0a0e1a;
      --panel: #131a2c;
      --line: rgba(123, 162, 255, 0.08);
    }

    body {
      background: var(--bg);
      background-image:
        linear-gradient(var(--line) 1px, transparent 1px),
        linear-gradient(90deg, var(--line) 1px, transparent 1px);
      background-size: 34px 34px;
    }

    .subtitle {
      font-size: .72rem;
      color: #8fa3c7;
      margin-top: 8px;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .bg-locked header,
    .bg-locked main {
      pointer-events: none;
    }

    .modal {
      max-width: 620px;
      max-height: 88vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background: #0f1628;
      border-color: #2a3553;
    }

    .modal-tabs {
      display: flex;
      gap: 6px;
      border-bottom: 1px solid #2a3553;
      padding: 0 20px;
      margin-top: 8px;
    }

    .tab-btn {
      border: none;
      background: none;
      color: #8fa3c7;
      font-size: .74rem;
      padding: 10px 8px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-weight: 700;
    }

    .tab-btn.active {
      color: #e2e8f0;
      border-bottom-color: #a78bfa;
    }

    .tab-panel {
      display: none;
      overflow-y: auto;
      padding-right: 2px;
    }

    .tab-panel.active { display: block; }

    .resource-list,
    .question-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .resource-item,
    .question-item {
      border: 1px solid #2a3553;
      background: #141c30;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: .82rem;
      color: #cbd5e1;
    }

    .resource-item a { color: #93c5fd; }
    .question-item summary { cursor: pointer; font-weight: 700; }


    @media (prefers-reduced-motion: reduce) {
      * {
        animation: none !important;
        transition: none !important;
        scroll-behavior: auto !important;
      }
    }

    @media (max-width: 768px) {
      header { padding-top: 26px; }
      header h1 { font-size: 1.6rem; }
      .roadmap::before { display: none; }
      .nodes-row { gap: 10px; }
      .node { width: min(100%, 360px); }
      .level-header { margin-top: 24px; }
      .modal { padding: 20px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>üßÆ Roadmap de Matem√°tica</h1>
    <p>Do zero absoluto at√© a matem√°tica universit√°ria avan√ßada. Clique em qualquer t√≥pico para aprender mais.</p>
    <p class="subtitle">modo estudo + recursos + quest√µes</p>
    <div class="progress-bar-wrap" role="progressbar" aria-label="Progresso de t√≥picos conclu√≠dos" aria-valuemin="0" aria-valuemax="35" aria-valuenow="0">
      <div class="progress-bar" id="pbar"></div>
    </div>
    <div class="progress-label" id="plabel">0 de 35 t√≥picos conclu√≠dos</div>
    <div class="top-actions">
      <button class="btn" id="share-btn" type="button">üîó Copiar link do site</button>
      <button class="btn" id="next-btn" type="button">‚ñ∂ Continuar estudo</button>
      <button class="btn" id="export-btn" type="button">‚¨á Exportar progresso</button>
      <button class="btn" id="import-btn" type="button">‚¨Ü Importar progresso</button>
      <button class="btn" id="clear-btn" type="button">‚ôªÔ∏è Limpar progresso</button>
      <input id="import-file" type="file" accept="application/json" hidden />
    </div>
    <div class="feedback" id="feedback" aria-live="polite"></div>
    <div class="search-wrap">
      <input class="search-input" id="search-input" type="search" placeholder="Buscar t√≥pico (ex: derivadas, fra√ß√µes, matrizes...)" aria-label="Buscar t√≥picos no roadmap" />
    </div>
  </header>

  <main class="roadmap" id="roadmap" aria-label="Roadmap de Matem√°tica"></main>

  <div class="modal-overlay" id="modal" aria-hidden="true">
    <div class="modal" id="modal-box" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-desc">
      <button class="close-btn" type="button" id="close-btn" aria-label="Fechar modal">‚úï</button>
      <div id="modal-icon" style="font-size:2rem;margin-bottom:8px" aria-hidden="true"></div>
      <h2 id="modal-title"></h2>
      <div class="modal-tags" id="modal-tags"></div>
      <div class="modal-tabs" role="tablist" aria-label="Conte√∫do do t√≥pico">
        <button class="tab-btn active" id="tabbtn-overview" data-tab="overview" role="tab" aria-selected="true" aria-controls="tab-overview" tabindex="0">üìñ Vis√£o geral</button>
        <button class="tab-btn" id="tabbtn-resources" data-tab="resources" role="tab" aria-selected="false" aria-controls="tab-resources" tabindex="-1">üîó Recursos</button>
        <button class="tab-btn" id="tabbtn-questions" data-tab="questions" role="tab" aria-selected="false" aria-controls="tab-questions" tabindex="-1">üéØ Quest√µes</button>
      </div>
      <div class="mbody" style="padding:16px 20px;overflow-y:auto;flex:1">
        <section class="tab-panel active" id="tab-overview" role="tabpanel" aria-labelledby="tabbtn-overview">
          <p id="modal-desc"></p>
          <ul id="modal-topics"></ul>
        </section>
        <section class="tab-panel" id="tab-resources" role="tabpanel" aria-labelledby="tabbtn-resources" hidden>
          <div class="resource-list" id="modal-resources"></div>
        </section>
        <section class="tab-panel" id="tab-questions" role="tabpanel" aria-labelledby="tabbtn-questions" hidden>
          <div class="question-list" id="modal-questions"></div>
        </section>
      </div>
      <button class="mark-btn" id="mark-btn" type="button"></button>
    </div>
  </div>

  <script>
    const levels = [
      {
        id: 'lv0', label: '‚Äî N√≠vel 0 ¬∑ Ponto de Partida ‚Äî', badge: 'badge-lv0',
        nodes: [
          { id: 'n0', icon: 'üî¢', title: 'N√∫meros e Contagem', sub: 'Naturais, inteiros, zero', desc: 'Tudo come√ßa aqui. N√∫meros s√£o a linguagem do universo. Voc√™ aprende a nomear quantidades, entender o zero (que levou mil√™nios pra ser aceito!) e contar sem limites.', topics: ['N√∫meros naturais (0, 1, 2, 3...)', 'Linha num√©rica', 'Comparar e ordenar n√∫meros', 'O que √© o zero?', 'Infinito: existe?'] },
          { id: 'n1', icon: '‚ûï', title: 'Opera√ß√µes B√°sicas', sub: 'Soma, subtra√ß√£o, multiplica√ß√£o, divis√£o', desc: 'As 4 opera√ß√µes s√£o as ferramentas fundamentais. Tudo mais em matem√°tica √© uma combina√ß√£o dessas quatro.', topics: ['Adi√ß√£o e subtra√ß√£o', 'Multiplica√ß√£o (tabuada)', 'Divis√£o exata e com resto', 'Propriedades comutativa, associativa, distributiva', 'Ordem das opera√ß√µes (PEMDAS)'] },
          { id: 'n2', icon: 'üß©', title: 'Fra√ß√µes', sub: 'Partes do todo', desc: 'Fra√ß√µes existem porque o mundo n√£o √© inteiro. Voc√™ precisa dividir uma pizza, medir 1/3 de x√≠cara. O conceito de "parte por inteiro" √© crucial.', topics: ['Numerador e denominador', 'Fra√ß√µes equivalentes', 'Simplifica√ß√£o', 'Soma e subtra√ß√£o de fra√ß√µes', 'Multiplica√ß√£o e divis√£o de fra√ß√µes'] },
          { id: 'n3', icon: 'üíØ', title: 'Decimais e Porcentagem', sub: 'Fra√ß√µes no formato decimal', desc: 'Decimais s√£o fra√ß√µes com denominador pot√™ncia de 10. Porcentagem √© "por cento", literalmente fra√ß√£o com denominador 100.', topics: ['Nota√ß√£o decimal', 'Convers√£o fra√ß√£o ‚Üî decimal', 'O que √© %?', 'Calcular desconto e acr√©scimo', 'Juros simples b√°sico'] },
        ]
      },
      {
        id: 'lv1', label: '‚Äî N√≠vel 1 ¬∑ Aritm√©tica ‚Äî', badge: 'badge-lv1',
        nodes: [
          { id: 'n4', icon: '‚ö°', title: 'Potencia√ß√£o e Radicia√ß√£o', sub: 'Multiplica√ß√£o repetida', desc: 'Pot√™ncia √© um atalho para multiplica√ß√£o repetida. 2‚Å∏ = 256. Raiz √© a opera√ß√£o inversa. S√£o a base de crescimento exponencial, algo presente em finan√ßas, biologia e f√≠sica.', topics: ['Pot√™ncias inteiras', 'Propriedades das pot√™ncias', 'Raiz quadrada e c√∫bica', 'N√∫meros irracionais (‚àö2)', 'Nota√ß√£o cient√≠fica'] },
          { id: 'n5', icon: 'üîó', title: 'Divisibilidade', sub: 'MMC, MDC, primos', desc: 'Todo n√∫mero √© feito de "√°tomos" chamados n√∫meros primos. O crivo de Erat√≥stenes √© um dos algoritmos mais antigos da hist√≥ria (276 a.C.)!', topics: ['Crit√©rios de divisibilidade', 'N√∫meros primos', 'Fatora√ß√£o em primos', 'MMC e MDC', 'Teorema fundamental da Aritm√©tica'] },
          { id: 'n6', icon: '‚öñÔ∏è', title: 'Raz√£o e Propor√ß√£o', sub: 'Rela√ß√µes entre grandezas', desc: 'Raz√£o √© uma compara√ß√£o. Propor√ß√£o √© quando duas raz√µes s√£o iguais. Escala, velocidade, receitas culin√°rias ‚Äî tudo usa propor√ß√£o.', topics: ['Raz√£o a:b', 'Propor√ß√µes', 'Regra de 3 simples', 'Regra de 3 composta', 'Grandezas diretamente/inversamente proporcionais'] },
        ]
      },
      {
        id: 'lv2', label: '‚Äî N√≠vel 2 ¬∑ √Ålgebra B√°sica ‚Äî', badge: 'badge-lv2',
        nodes: [
          { id: 'n7', icon: 'üî§', title: 'Vari√°veis e Express√µes', sub: 'Letras em vez de n√∫meros', desc: 'Uma vari√°vel √© um n√∫mero que voc√™ ainda n√£o sabe. A √°lgebra √© a arte de trabalhar com o desconhecido. Einstein usou isso pra chegar em E=mc¬≤.', topics: ['O que √© uma vari√°vel?', 'Express√µes alg√©bricas', 'Polin√¥mios', 'Fatora√ß√£o b√°sica', 'Produtos not√°veis'] },
          { id: 'n8', icon: '‚ö°', title: 'Equa√ß√µes do 1¬∫ Grau', sub: 'Achar o valor de x', desc: 'Uma equa√ß√£o √© uma balan√ßa: o que voc√™ faz de um lado, faz do outro. Resolver equa√ß√µes √© o cora√ß√£o da matem√°tica aplicada.', topics: ['Princ√≠pio da equival√™ncia', 'Equa√ß√µes lineares simples', 'Equa√ß√µes com fra√ß√µes', 'Verifica√ß√£o da solu√ß√£o', 'Problemas contextualizados'] },
          { id: 'n9', icon: 'üìê', title: 'Sistemas de Equa√ß√µes', sub: 'Mais de uma equa√ß√£o ao mesmo tempo', desc: 'Quando voc√™ tem dois desconhecidos, precisa de duas equa√ß√µes. Sistemas aparecem em todo c√°lculo de equil√≠brio, mistura e intersec√ß√£o.', topics: ['M√©todo da substitui√ß√£o', 'M√©todo da adi√ß√£o (elimina√ß√£o)', 'M√©todo gr√°fico', 'Sistema sem solu√ß√£o / infinitas solu√ß√µes', 'Aplica√ß√µes pr√°ticas'] },
          { id: 'n10', icon: 'üìè', title: 'Inequa√ß√µes', sub: 'Maior, menor, desigualdades', desc: 'Nem tudo √© igual. Inequa√ß√µes definem intervalos onde solu√ß√µes existem. Fundamentais em otimiza√ß√£o e programa√ß√£o linear.', topics: ['S√≠mbolos <, >, ‚â§, ‚â•', 'Inequa√ß√µes do 1¬∫ grau', 'Representa√ß√£o na reta num√©rica', 'Intervalos', 'Inequa√ß√µes compostas'] },
        ]
      },
      {
        id: 'lv3', label: '‚Äî N√≠vel 3 ¬∑ Geometria ‚Äî', badge: 'badge-lv3',
        nodes: [
          { id: 'n11', icon: 'üìê', title: 'Geometria Plana', sub: 'Figuras em 2D', desc: 'Pit√°goras descobriu que em todo tri√¢ngulo ret√¢ngulo, a¬≤ + b¬≤ = c¬≤. Esse √∫nico teorema √© a base da engenharia, arquitetura e GPS.', topics: ['Pontos, retas e planos', '√Çngulos', 'Tri√¢ngulos (Pit√°goras!)', 'Quadril√°teros e pol√≠gonos', 'Circunfer√™ncia e c√≠rculo', '√Årea e per√≠metro'] },
          { id: 'n12', icon: 'üì¶', title: 'Geometria Espacial', sub: 'Figuras em 3D', desc: 'O mundo real √© 3D. Volume de uma caixa, √°rea de uma lata, capacidade de um reservat√≥rio ‚Äî tudo √© geometria espacial.', topics: ['Prismas e pir√¢mides', 'Cilindros, cones, esferas', 'Volume e √°rea total', 'Planifica√ß√£o de s√≥lidos', 'Se√ß√µes transversais'] },
          { id: 'n13', icon: 'üì°', title: 'Trigonometria', sub: 'Seno, cosseno, tangente', desc: 'Trigonometria nasceu para medir o que n√£o dava pra alcan√ßar ‚Äî a altura de uma montanha, a dist√¢ncia at√© a Lua. soh-cah-toa √© s√≥ o come√ßo.', topics: ['Tri√¢ngulo ret√¢ngulo', 'Seno, cosseno, tangente', 'Lei dos senos e cossenos', '√Çngulos not√°veis (30¬∞, 45¬∞, 60¬∞)', 'Aplica√ß√µes de altura e dist√¢ncia'] },
        ]
      },
      {
        id: 'lv4', label: '‚Äî N√≠vel 4 ¬∑ √Ålgebra Intermedi√°ria ‚Äî', badge: 'badge-lv4',
        nodes: [
          { id: 'n14', icon: 'üåä', title: 'Equa√ß√µes do 2¬∫ Grau', sub: 'Baskara e f√≥rmula quadr√°tica', desc: 'ax¬≤ + bx + c = 0. A f√≥rmula de Bhaskara (nome correto!) veio do matem√°tico indiano Brahmagupta. O discriminante Œî decide tudo.', topics: ['Forma geral ax¬≤+bx+c', 'F√≥rmula de Bhaskara', 'Discriminante Œî', 'Produto e soma das ra√≠zes (Vi√®te)', 'Equa√ß√µes biquadr√°ticas'] },
          { id: 'n15', icon: 'üìà', title: 'Fun√ß√µes', sub: 'Rela√ß√µes de entrada e sa√≠da', desc: 'Uma fun√ß√£o √© uma m√°quina: entra x, sai f(x). Fun√ß√µes descrevem todo fen√¥meno do mundo: temperatura, crescimento, lucro.', topics: ['Defini√ß√£o de fun√ß√£o', 'Dom√≠nio, contradom√≠nio e imagem', 'Fun√ß√£o afim (linear)', 'Fun√ß√£o quadr√°tica (par√°bola)', 'Gr√°ficos e transforma√ß√µes'] },
          { id: 'n16', icon: 'üìâ', title: 'Fun√ß√µes Exponenciais e Log', sub: 'Crescimento e escala', desc: 'Exponencial descreve v√≠rus, d√≠vidas e explos√µes nucleares. Logaritmo √© o inverso ‚Äî e √© a escala da m√∫sica (d√≥-r√©-mi √© exponencial!).', topics: ['f(x) = aÀ£', 'Propriedades da exponencial', 'Defini√ß√£o de logaritmo', 'Propriedades do log', 'log natural (ln) e n√∫mero e'] },
          { id: 'n17', icon: 'üî¢', title: 'PA e PG', sub: 'Sequ√™ncias e progress√µes', desc: 'Progress√µes aritm√©tica (soma constante) e geom√©trica (raz√£o constante). Juros compostos √© uma PG. A soma dos termos gera f√≥rmulas elegant√≠ssimas.', topics: ['Sequ√™ncias num√©ricas', 'PA: defini√ß√£o e f√≥rmulas', 'PG: defini√ß√£o e f√≥rmulas', 'Soma dos termos', 'Aplica√ß√£o em juros compostos'] },
        ]
      },
      {
        id: 'lv5', label: '‚Äî N√≠vel 5 ¬∑ Pr√©-C√°lculo ‚Äî', badge: 'badge-lv5',
        nodes: [
          { id: 'n18', icon: 'üåÄ', title: 'Trigonometria Avan√ßada', sub: 'Ciclo trigonom√©trico', desc: 'Seno e cosseno s√£o fun√ß√µes peri√≥dicas ‚Äî descrevem ondas de som, luz, eletricidade. O c√≠rculo unit√°rio unifica tudo.', topics: ['Ciclo trigonom√©trico', 'Fun√ß√µes sen, cos, tg e inversas', 'Identidades trigonom√©tricas', 'F√≥rmulas de adi√ß√£o', 'Equa√ß√µes trigonom√©tricas'] },
          { id: 'n19', icon: 'üîÆ', title: 'N√∫meros Complexos', sub: 'A raiz de -1 existe!', desc: 'i = ‚àö(-1). Parece mentira, mas n√∫meros complexos s√£o a base da engenharia el√©trica, mec√¢nica qu√¢ntica e processamento de sinais. O plano de Argand √© lindo.', topics: ['Defini√ß√£o de i', 'Forma alg√©brica a+bi', 'Opera√ß√µes com complexos', 'M√≥dulo e argumento', 'F√≥rmula de Euler: e‚Å±À£ = cos x + i¬∑sen x'] },
          { id: 'n20', icon: 'üé≤', title: 'Combinat√≥ria', sub: 'Contar sem listar', desc: 'Quantas senhas de 4 d√≠gitos existem? Quantas m√£os no poker? Combinat√≥ria responde isso de forma exata e elegante.', topics: ['Princ√≠pio Fundamental da Contagem', 'Fatorial', 'Permuta√ß√µes', 'Combina√ß√µes', 'Bin√¥mio de Newton'] },
          { id: 'n21', icon: 'üìä', title: 'Probabilidade e Estat√≠stica B√°sica', sub: 'Incerteza com precis√£o', desc: 'Probabilidade quantifica o acaso. Estat√≠stica resume dados. Juntas, s√£o a base da ci√™ncia moderna, medicina, IA.', topics: ['Espa√ßo amostral e eventos', 'P(A) e regras b√°sicas', 'M√©dia, mediana, moda', 'Desvio padr√£o e vari√¢ncia', 'Distribui√ß√µes: normal, binomial'] },
        ]
      },
      {
        id: 'lv6', label: '‚Äî N√≠vel 6 ¬∑ C√°lculo ‚Äî', badge: 'badge-lv6',
        nodes: [
          { id: 'n22', icon: 'üî≠', title: 'Limites', sub: 'O que acontece quando x ‚Üí a', desc: 'Limite √© perguntar: "pra onde vai a fun√ß√£o enquanto x se aproxima de algo?" Newton e Leibniz inventaram o c√°lculo para descrever movimento. Aqui come√ßa a revolu√ß√£o.', topics: ['Conceito intuitivo de limite', 'Limites laterais', 'Limites no infinito', 'Formas indeterminadas', 'Continuidade de fun√ß√µes'] },
          { id: 'n23', icon: 'üìê', title: 'Derivadas', sub: 'Taxa de varia√ß√£o instant√¢nea', desc: 'Derivada √© a inclina√ß√£o da curva num ponto. Velocidade √© derivada da posi√ß√£o. Acelera√ß√£o √© derivada da velocidade. F√≠sica inteira usa isso.', topics: ['Defini√ß√£o via limite', 'Regras (produto, quociente, cadeia)', 'Derivadas elementares', 'M√°ximos e m√≠nimos', 'Aplica√ß√µes: otimiza√ß√£o'] },
          { id: 'n24', icon: 'üåä', title: 'Integrais', sub: '√Årea sob a curva', desc: 'Integral √© a opera√ß√£o inversa da derivada (Teorema Fundamental do C√°lculo). Com ela voc√™ calcula √°rea, volume, trabalho, probabilidade.', topics: ['Integral como √°rea', 'Integral indefinida e definida', 'Regras de integra√ß√£o', 'Integra√ß√£o por substitui√ß√£o', 'Integral por partes'] },
          { id: 'n25', icon: 'üåÄ', title: 'Equa√ß√µes Diferenciais', sub: 'Equa√ß√µes com derivadas', desc: 'A f√≠sica do universo √© escrita em EDOs. F=ma √© uma equa√ß√£o diferencial. Crescimento populacional, circuitos el√©tricos, calor ‚Äî tudo.', topics: ['O que √© uma EDO?', 'EDOs de 1¬™ ordem separ√°veis', 'EDOs lineares com coeficiente constante', 'Modelo de crescimento (Malthus)', 'Circuitos RC e osciladores'] },
        ]
      },
      {
        id: 'lv7', label: '‚Äî N√≠vel 7 ¬∑ √Ålgebra Linear ‚Äî', badge: 'badge-lv7',
        nodes: [
          { id: 'n26', icon: '‚û°Ô∏è', title: 'Vetores', sub: 'Grandezas com dire√ß√£o', desc: 'Vetores t√™m magnitude e dire√ß√£o. S√£o a linguagem da f√≠sica, computa√ß√£o gr√°fica e machine learning. Todo embedding de IA √© um vetor.', topics: ['Defini√ß√£o e nota√ß√£o', 'Opera√ß√µes: soma e escalar', 'Produto escalar (dot product)', 'Produto vetorial (cross product)', 'Proje√ß√£o e ortogonalidade'] },
          { id: 'n27', icon: 'üü©', title: 'Matrizes', sub: 'Grades de n√∫meros', desc: 'Matrizes organizam sistemas de equa√ß√µes. S√£o o cora√ß√£o de transforma√ß√µes lineares, redes neurais e gr√°ficos 3D (rota√ß√£o, escala, transla√ß√£o s√£o matrizes!).', topics: ['Defini√ß√£o e opera√ß√µes', 'Multiplica√ß√£o de matrizes', 'Matriz transposta e inversa', 'Determinante', 'Sistemas lineares via matrizes (Gauss)'] },
          { id: 'n28', icon: 'üîÅ', title: 'Espa√ßos Vetoriais', sub: 'Estrutura abstrata', desc: 'Um espa√ßo vetorial √© qualquer conjunto com soma e escalar que obedecem certas regras. Fun√ß√µes, polin√¥mios e matrizes s√£o espa√ßos vetoriais!', topics: ['Axiomas do espa√ßo vetorial', 'Subespa√ßos', 'Base e dimens√£o', 'Independ√™ncia linear', 'Transforma√ß√µes lineares'] },
          { id: 'n29', icon: 'üéØ', title: 'Autovalores e Autovetores', sub: 'A "geometria" das transforma√ß√µes', desc: 'Autovetores s√£o as dire√ß√µes que uma transforma√ß√£o n√£o "vira" ‚Äî s√≥ escala. Google PageRank, an√°lise de componentes principais (PCA) em IA ‚Äî tudo usa isso.', topics: ['Defini√ß√£o de autovalor Œª', 'Equa√ß√£o caracter√≠stica', 'Diagonaliza√ß√£o', 'Decomposi√ß√£o espectral', 'Aplica√ß√£o em PCA e Machine Learning'] },
        ]
      },
      {
        id: 'lv8', label: '‚Äî N√≠vel 8 ¬∑ Matem√°tica Avan√ßada ‚Äî', badge: 'badge-lv8',
        nodes: [
          { id: 'n30', icon: 'üß†', title: 'An√°lise Real', sub: 'O rigor por tr√°s do C√°lculo', desc: 'An√°lise Real √© o C√°lculo com prova formal. Aqui voc√™ entende o que "limite" significa de verdade, com √©psilons e deltas. Matem√°tica pura come√ßa aqui.', topics: ['Sequ√™ncias e s√©ries convergentes', 'Defini√ß√£o Œµ-Œ¥ de limite', 'Teorema do Valor Intermedi√°rio', 'Completude dos reais', 'Integra√ß√£o de Riemann'] },
          { id: 'n31', icon: 'üî£', title: '√Ålgebra Abstrata', sub: 'Grupos, an√©is e corpos', desc: 'Grupos s√£o estruturas com uma opera√ß√£o e 4 axiomas. Parecem abstratos, mas descrevem simetrias da f√≠sica de part√≠culas, criptografia RSA e muito mais.', topics: ['Grupos e subgrupos', 'Homomorfismos', 'An√©is e ideais', 'Corpos (fields)', 'Teoria de Galois (no√ß√£o)'] },
          { id: 'n32', icon: 'üåê', title: 'Topologia', sub: 'Geometria sem dist√¢ncia', desc: 'Topologia estuda o que n√£o muda quando voc√™ estica ou dobra um espa√ßo (sem rasgar). Uma x√≠cara e uma rosquinha s√£o topologicamente id√™nticas ‚Äî e isso n√£o √© piada!', topics: ['Espa√ßos m√©tricos', 'Espa√ßos topol√≥gicos', 'Continuidade topol√≥gica', 'Compacidade e conexidade', 'No√ß√£o de homeomorfismo'] },
          { id: 'n33', icon: 'üì°', title: 'C√°lculo em V√°rias Vari√°veis', sub: 'Fun√ß√µes de ‚Ñù‚Åø ‚Üí ‚Ñù·µê', desc: 'O mundo tem mais de uma vari√°vel. Gradiente, divergente, rotacional ‚Äî ferramentas do c√°lculo multivari√°vel s√£o a base da f√≠sica, eletromagnetismo e deep learning.', topics: ['Fun√ß√µes de 2+ vari√°veis', 'Derivadas parciais', 'Gradiente e plano tangente', 'Integrais duplas e triplas', 'Teoremas de Green, Stokes, Gauss'] },
          { id: 'n34', icon: 'üé≤', title: 'Probabilidade Avan√ßada', sub: 'Teoria da medida e processos', desc: 'Probabilidade formal usa teoria da medida. Processos estoc√°sticos descrevem o mercado financeiro, difus√£o de mol√©culas e passeios aleat√≥rios.', topics: ['Sigma-√°lgebras e medida', 'Vari√°veis aleat√≥rias cont√≠nuas', 'Distribui√ß√µes avan√ßadas', 'Processos de Markov', 'Movimento Browniano'] },
        ]
      },
    ];

    const allNodes = levels.flatMap(level => level.nodes);
    const nodeById = new Map(allNodes.map(node => [node.id, node]));

    function readDoneFromStorage() {
      try {
        const stored = JSON.parse(localStorage.getItem('math_done') || '[]');
        if (!Array.isArray(stored)) return new Set();
        const validIds = stored.filter(id => typeof id === 'string' && nodeById.has(id));
        return new Set(validIds);
      } catch {
        return new Set();
      }
    }

    const done = readDoneFromStorage();
    const modal = document.getElementById('modal');
    const modalBox = document.getElementById('modal-box');
    const progressWrap = document.querySelector('.progress-bar-wrap');
    const feedback = document.getElementById('feedback');
    const searchInput = document.getElementById('search-input');
    const pageRoots = [document.querySelector('header'), document.querySelector('main')];
    const supportsInert = 'inert' in HTMLElement.prototype;
    let lastFocusedEl = null;
    let previousBodyOverflow = '';

    function showFeedback(message, isError = false) {
      feedback.textContent = message;
      feedback.style.color = isError ? '#f87171' : '#34d399';
      window.clearTimeout(showFeedback.timeoutId);
      showFeedback.timeoutId = window.setTimeout(() => {
        feedback.textContent = '';
      }, 2400);
    }

    function saveDone() {
      try {
        localStorage.setItem('math_done', JSON.stringify([...done]));
        return true;
      } catch {
        showFeedback('Falha ao salvar (armazenamento cheio ou bloqueado).', true);
        return false;
      }
    }

    function updateProgress() {
      const total = allNodes.length;
      const n = done.size;
      const pct = total === 0 ? 0 : (n / total) * 100;

      document.getElementById('pbar').style.width = `${pct}%`;
      document.getElementById('plabel').textContent = `${n} de ${total} t√≥picos conclu√≠dos`;
      progressWrap.setAttribute('aria-valuenow', String(n));
      progressWrap.setAttribute('aria-valuemax', String(total));
    }

    function buildRoadmap() {
      const container = document.getElementById('roadmap');

      levels.forEach((lv, li) => {
        const lvDiv = document.createElement('section');
        lvDiv.className = `level ${lv.id}`;

        const header = document.createElement('div');
        header.className = 'level-header';
        header.innerHTML = `<span class="level-badge ${lv.badge}">${lv.label}</span>`;
        lvDiv.appendChild(header);

        const row = document.createElement('div');
        row.className = 'nodes-row';

        lv.nodes.forEach(nodeData => {
          const node = document.createElement('button');
          node.className = `node${done.has(nodeData.id) ? ' done' : ''}`;
          node.type = 'button';
          node.dataset.nodeId = nodeData.id;
          node.setAttribute('aria-label', `${nodeData.title} - ${nodeData.sub}`);
          node.setAttribute('aria-controls', 'modal-box');
          node.setAttribute('aria-haspopup', 'dialog');
          node.setAttribute('aria-pressed', done.has(nodeData.id) ? 'true' : 'false');
          node.dataset.search = `${nodeData.title} ${nodeData.sub} ${nodeData.desc} ${nodeData.topics.join(' ')}`.toLowerCase();
          node.innerHTML = `<div class="node-icon">${nodeData.icon}</div><div class="node-title">${nodeData.title}</div><div class="node-sub">${nodeData.sub}</div>`;
          row.appendChild(node);
        });

        lvDiv.appendChild(row);

        if (li < levels.length - 1) {
          const c = document.createElement('div');
          c.className = 'connector';
          c.textContent = '‚¨á';
          lvDiv.appendChild(c);
        }

        container.appendChild(lvDiv);
      });

      updateProgress();
    }

    let currentNode = null;

    function getFocusable(root) {
      return [...root.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')]
        .filter(el => !el.disabled && el.getAttribute('aria-hidden') !== 'true');
    }

    function setBackgroundInert(isOpen) {
      pageRoots.forEach(root => {
        if (!root) return;
        if (supportsInert) {
          if (isOpen) root.setAttribute('inert', '');
          else root.removeAttribute('inert');
        } else {
          if (isOpen) root.setAttribute('aria-hidden', 'true');
          else root.removeAttribute('aria-hidden');
        }
      });
      document.body.classList.toggle('bg-locked', isOpen && !supportsInert);
    }

    function syncHash(nodeId) {
      if (!nodeId) {
        history.replaceState(null, '', `${location.pathname}${location.search}`);
        return;
      }
      history.replaceState(null, '', `#${nodeId}`);
    }

    function onModalKeydown(event) {
      if (!modal.classList.contains('open')) return;

      if (event.key === 'Escape') {
        closeModal();
        return;
      }

      if (event.key !== 'Tab') return;
      const focusables = getFocusable(modalBox);
      if (!focusables.length) return;

      const first = focusables[0];
      const last = focusables[focusables.length - 1];

      if (event.shiftKey && document.activeElement === first) {
        event.preventDefault();
        last.focus();
      } else if (!event.shiftKey && document.activeElement === last) {
        event.preventDefault();
        first.focus();
      }
    }

    function getActiveTab() {
      return document.querySelector('.tab-btn.active')?.dataset.tab || 'overview';
    }

    function safeHttpUrl(rawUrl) {
      try {
        const url = new URL(rawUrl, location.origin);
        if (url.protocol === 'http:' || url.protocol === 'https:') return url.href;
      } catch {}
      return null;
    }

    function renderResources(resources) {
      const resourcesWrap = document.getElementById('modal-resources');
      resourcesWrap.innerHTML = '';

      resources.forEach(resource => {
        const safeUrl = safeHttpUrl(resource.url);
        if (!safeUrl) return;

        const item = document.createElement('div');
        item.className = 'resource-item';

        const link = document.createElement('a');
        link.href = safeUrl;
        link.target = '_blank';
        link.rel = 'noopener';
        link.textContent = resource.name || resource.t || 'Recurso';

        item.appendChild(link);
        resourcesWrap.appendChild(item);
      });

      if (!resourcesWrap.children.length) {
        const empty = document.createElement('div');
        empty.className = 'resource-item';
        empty.textContent = 'Sem recursos v√°lidos para este t√≥pico.';
        resourcesWrap.appendChild(empty);
      }
    }

    function renderTags(subtitle) {
      const tagsWrap = document.getElementById('modal-tags');
      tagsWrap.innerHTML = '';
      const tag = document.createElement('span');
      tag.className = 'tag';
      tag.textContent = `üìö ${subtitle}`;
      tagsWrap.appendChild(tag);
    }

    function renderTopics(topics) {
      const list = document.getElementById('modal-topics');
      list.innerHTML = '';
      topics.forEach(topic => {
        const li = document.createElement('li');
        li.textContent = topic;
        list.appendChild(li);
      });
    }

    function renderQuestions(questions) {
      const questionsWrap = document.getElementById('modal-questions');
      questionsWrap.innerHTML = '';

      questions.forEach((question, index) => {
        const details = document.createElement('details');
        details.className = 'question-item';

        const summary = document.createElement('summary');
        summary.textContent = `${index + 1}. ${question.q}`;

        const answer = document.createElement('p');
        answer.style.marginTop = '8px';
        answer.textContent = question.a || 'Sem resposta cadastrada.';

        details.appendChild(summary);
        details.appendChild(answer);
        questionsWrap.appendChild(details);
      });
    }

    function openModal(nodeData, triggerEl = null) {
      const wasOpen = modal.classList.contains('open');
      const activeTab = wasOpen ? getActiveTab() : 'overview';
      currentNode = nodeData;
      document.getElementById('modal-icon').textContent = nodeData.icon;
      document.getElementById('modal-title').textContent = nodeData.title;
      document.getElementById('modal-desc').textContent = nodeData.desc;

      renderTags(nodeData.sub);
      renderTopics(nodeData.topics);

      const defaultResources = [
        { name: 'Khan Academy', url: 'https://pt.khanacademy.org/' },
        { name: 'Professor Ferretto', url: 'https://www.youtube.com/@ProfessorFerretto' },
      ];
      const resources = nodeData.resources || defaultResources;
      renderResources(resources);

      const questions = nodeData.questions || [
        { q: `Explique com suas palavras o t√≥pico ${nodeData.title}.`, a: 'Resposta pessoal.' },
        { q: `D√™ um exemplo pr√°tico de ${nodeData.title}.`, a: 'Resposta pessoal.' },
      ];
      renderQuestions(questions);

      const btn = document.getElementById('mark-btn');
      const isDone = done.has(nodeData.id);
      btn.textContent = isDone ? '‚Ü© Marcar como n√£o conclu√≠do' : '‚úì Marcar como conclu√≠do';
      btn.className = `mark-btn${isDone ? ' undone' : ''}`;

      if (!wasOpen) {
        lastFocusedEl = triggerEl || document.activeElement;
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        setBackgroundInert(true);
        previousBodyOverflow = document.body.style.overflow;
        document.body.style.overflow = 'hidden';
        document.addEventListener('keydown', onModalKeydown, true);
      }
      syncHash(nodeData.id);
      switchTab(activeTab, false);
      btn.focus();
    }

    function updateNodeVisualState(nodeId) {
      const button = document.querySelector(`[data-node-id="${nodeId}"]`);
      if (!button) return;
      const isDone = done.has(nodeId);
      button.classList.toggle('done', isDone);
      button.setAttribute('aria-pressed', isDone ? 'true' : 'false');
    }

    function toggleDone() {
      if (!currentNode) return;

      if (done.has(currentNode.id)) {
        done.delete(currentNode.id);
      } else {
        done.add(currentNode.id);
      }

      updateNodeVisualState(currentNode.id);
      saveDone();
      updateProgress();
      openModal(currentNode);
    }

    function closeModal() {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      setBackgroundInert(false);
      document.body.style.overflow = previousBodyOverflow;
      document.removeEventListener('keydown', onModalKeydown, true);
      syncHash('');
      if (lastFocusedEl && typeof lastFocusedEl.focus === 'function') {
        lastFocusedEl.focus();
      }
    }

    document.getElementById('roadmap').addEventListener('click', event => {
      const target = event.target.closest('[data-node-id]');
      if (!target) return;

      const nodeData = nodeById.get(target.dataset.nodeId);
      if (!nodeData) return;
      openModal(nodeData, target);
    });

    modal.addEventListener('click', event => {
      if (event.target.id === 'modal') closeModal();
    });

    document.getElementById('close-btn').addEventListener('click', closeModal);
    document.getElementById('mark-btn').addEventListener('click', toggleDone);
    document.getElementById('clear-btn').addEventListener('click', () => {
      const shouldClear = window.confirm('Deseja remover todo o progresso salvo neste navegador?');
      if (!shouldClear) return;
      done.clear();
      saveDone();
      document.querySelectorAll('[data-node-id]').forEach(node => updateNodeVisualState(node.dataset.nodeId));
      updateProgress();
      showFeedback('Progresso limpo com sucesso.');
    });

    document.getElementById('share-btn').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        showFeedback('Link copiado! Agora voc√™ pode abrir no PC ou celular.');
      } catch {
        const ok = window.prompt('Copie o link abaixo:', window.location.href);
        showFeedback(ok === null ? 'C√≥pia cancelada.' : 'Link exibido para c√≥pia manual.', ok === null);
      }
    });

    searchInput.addEventListener('input', event => {
      const query = event.target.value.trim().toLowerCase();
      const nodes = document.querySelectorAll('[data-node-id]');
      let visible = 0;

      nodes.forEach(node => {
        const match = query.length === 0 || node.dataset.search.includes(query);
        node.style.display = match ? '' : 'none';
        if (match) visible += 1;
      });

      if (query.length === 0) {
        showFeedback('');
      } else {
        showFeedback(`${visible} t√≥pico(s) encontrado(s).`, visible === 0);
      }
    });



    document.getElementById('next-btn').addEventListener('click', () => {
      const nextNode = allNodes.find(node => !done.has(node.id));
      if (!nextNode) {
        showFeedback('Parab√©ns! Todos os t√≥picos foram conclu√≠dos.');
        return;
      }
      const trigger = document.querySelector(`[data-node-id="${nextNode.id}"]`);
      if (trigger) {
        const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        trigger.scrollIntoView({ block: 'center', behavior: reduce ? 'auto' : 'smooth' });
      }
      openModal(nextNode, trigger || document.getElementById('next-btn'));
    });

    document.getElementById('export-btn').addEventListener('click', () => {
      const payload = {
        version: 1,
        exportedAt: new Date().toISOString(),
        done: [...done],
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'math-roadmap-progress.json';
      link.click();
      window.setTimeout(() => URL.revokeObjectURL(url), 1000);
      showFeedback('Progresso exportado em JSON.');
    });

    const importFileInput = document.getElementById('import-file');
    document.getElementById('import-btn').addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', async event => {
      const file = event.target.files?.[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);
        const ids = Array.isArray(data) ? data : data.done;
        if (!Array.isArray(ids)) throw new Error('Formato inv√°lido');

        const validIds = ids.filter(id => typeof id === 'string' && nodeById.has(id));
        done.clear();
        validIds.forEach(id => done.add(id));

        document.querySelectorAll('[data-node-id]').forEach(node => {
          updateNodeVisualState(node.dataset.nodeId);
        });

        saveDone();
        updateProgress();
        showFeedback(`Importa√ß√£o conclu√≠da: ${validIds.length} t√≥picos carregados.`);
      } catch {
        showFeedback('Arquivo inv√°lido para importa√ß√£o.', true);
      } finally {
        importFileInput.value = '';
      }
    });

    // Nota: hashchange n√£o dispara quando usamos history.replaceState/pushState.

    function switchTab(tabId, focus = true) {
      const tabs = [...document.querySelectorAll('.tab-btn')];
      tabs.forEach(tab => {
        const active = tab.dataset.tab === tabId;
        tab.classList.toggle('active', active);
        tab.setAttribute('aria-selected', active ? 'true' : 'false');
        tab.tabIndex = active ? 0 : -1;
        if (active && focus) tab.focus();
      });

      document.querySelectorAll('.tab-panel').forEach(panel => {
        const active = panel.id === `tab-${tabId}`;
        panel.classList.toggle('active', active);
        panel.toggleAttribute('hidden', !active);
      });
    }

    document.querySelectorAll('.tab-btn').forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    document.querySelector('.modal-tabs').addEventListener('keydown', event => {
      const tabs = [...document.querySelectorAll('.tab-btn')];
      const currentIndex = tabs.indexOf(document.activeElement);
      if (currentIndex < 0) return;

      let nextIndex = null;
      if (event.key === 'ArrowRight') nextIndex = (currentIndex + 1) % tabs.length;
      if (event.key === 'ArrowLeft') nextIndex = (currentIndex - 1 + tabs.length) % tabs.length;
      if (event.key === 'Home') nextIndex = 0;
      if (event.key === 'End') nextIndex = tabs.length - 1;

      if (nextIndex === null) return;
      event.preventDefault();
      switchTab(tabs[nextIndex].dataset.tab);
    });

    window.addEventListener('hashchange', () => {
      const id = window.location.hash.replace('#', '');
      if (!id) {
        if (modal.classList.contains('open')) closeModal();
        return;
      }
      const nodeData = nodeById.get(id);
      if (nodeData) {
        const trigger = document.querySelector(`[data-node-id="${id}"]`);
        openModal(nodeData, trigger || document.body);
      }
    });

    buildRoadmap();

    const hashId = window.location.hash.replace('#', '');
    if (hashId && nodeById.has(hashId)) {
      const trigger = document.querySelector(`[data-node-id="${hashId}"]`);
      openModal(nodeById.get(hashId), trigger || document.body);
    }
  </script>
</body>
</html>
